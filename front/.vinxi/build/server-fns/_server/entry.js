import{fromJSON as I,crossSerializeStream as L,getCrossReferenceHeader as $}from"seroval";import{CustomEventPlugin as g,DOMExceptionPlugin as b,EventPlugin as y,FormDataPlugin as R,HeadersPlugin as S,ReadableStreamPlugin as w,RequestPlugin as P,ResponsePlugin as q,URLSearchParamsPlugin as x,URLPlugin as E}from"seroval-plugins/web";import{sharedConfig as U}from"solid-js";import{provideRequestEvent as C}from"solid-js/web/storage";import{getRequestURL as v,getRequestWebStream as F,getRequestIP as W,eventHandler as k,setHeader as D}from"h3";const d="Invariant Violation",{setPrototypeOf:N=function(e,t){return e.__proto__=t,e}}=Object;class p extends Error{framesToPop=1;name=d;constructor(t=d){super(typeof t=="number"?`${d}: ${t} (see https://github.com/apollographql/invariant-packages)`:t),N(this,p.prototype)}}function m(e,t){if(!e)throw new p(t)}function z(e){let t;const r=v(e),s={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(r,{...s,body:e.node.req.body}):new Request(r,{...s,get body(){return t||(t=F(e),t)}})}function A(e){return e.web??={request:z(e),url:v(e)},e.web.request}const O=Symbol("h3Event"),f=Symbol("fetchEvent"),J={get(e,t){return t===f?e:e[t]??e[O][t]}};function M(e){const t=A(e);return new Proxy({request:t,clientAddress:W(e),locals:{},[O]:e},J)}function _(e){if(!e[f]){const t=M(e);e[f]=t}return e[f]}function j(e){const r=e.length.toString(16),s="00000000".substring(0,8-r.length)+r;return new TextEncoder().encode(`;0x${s};${e}`)}function B(e,t){return new ReadableStream({start(r){L(t,{scopeId:e,plugins:[g,b,y,R,S,w,P,q,x,E],onSerialize(s,a){r.enqueue(j(a?`(${$(e)},${s})`:s))},onDone(){r.close()},onError(s){r.error(s)}})}})}async function V(e){m(e.method==="POST",`Invalid method ${e.method}. Expected POST.`);const t=_(e),r=t.request,s=r.headers.get("x-server-id"),a=r.headers.get("x-server-instance"),i=new URL(r.url);let c,u;if(s)m(typeof s=="string","Invalid server function"),[c,u]=s.split("#");else if(c=i.searchParams.get("id"),u=i.searchParams.get("name"),!c||!u)throw new Error("Invalid request");const T=(await globalThis.MANIFEST["server-fns"].chunks[c].import())[u];let o=[];if(!a){const n=i.searchParams.get("args");n&&JSON.parse(n).forEach(l=>o.push(l))}const h=r.headers.get("content-type");h.startsWith("multipart/form-data")||h.startsWith("application/x-www-form-urlencoded")?o.push(await r.formData()):o=I(await r.json(),{plugins:[g,b,y,R,S,w,P,q,x,E]});try{const n=await C(t,()=>(U.context={event:t},T(...o)));if(!a){const l=n instanceof Error,H=new URL(r.headers.get("referer"));return new Response(null,{status:302,headers:{Location:H.toString(),...n?{"Set-Cookie":`flash=${JSON.stringify({url:i.pathname+encodeURIComponent(i.search),result:l?n.message:n,error:l,input:[...o.slice(0,-1),[...o[o.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return typeof n=="string"?new Response(n):(D(e,"content-type","text/javascript"),B(a,n))}catch(n){return n instanceof Response&&n.status===302?new Response(null,{status:a?204:302,headers:{Location:n.headers.get("Location")}}):n}}const Z=k(V);export{Z as default};
